#!/usr/bin/env ruby

require 'lib/tack'
require 'pp'
require 'optparse'

options = {}
option_parser = OptionParser.new do |opts|
  opts.banner = "Usage: tack [options] [file]"
  opts.on("-I","--include PATH", "specify $LOAD_PATH (may be used more than once)") do |path|
    options[:include] = path.split(":")
  end
  opts.on("-n", "--name PATTERN", "run only tests that match pattern") do |pattern|
    if pattern=~/^\/.*\/$/
     options[:pattern] = Regexp.new(pattern[1..-2])
    else
      options[:pattern] = pattern
    end
  end
  opts.on_tail("-h","--help", "Show this message") do
    puts opts
    exit
  end
end

args = ARGV
option_parser.parse! args
options[:file] = args.last if args.last

if includes = options[:include]
  $LOAD_PATH.unshift *includes
end

#results = Tack::Runner.new(Dir.pwd).run(tests)

runner = Tack::Runner.new(:root => Dir.pwd) do |runner|
  runner.use Tack::Formatters::Profiler, :tests => 3
  runner.use Tack::Formatters::TotalTime
  runner.use Tack::Formatters::BasicSummary
  runner.use Tack::Formatters::ProgressBar
  # runner.use Tack::Formatter::Failures
end

set = Tack::TestSet.new(Dir.pwd)
tests = set.tests_for(options[:file], Tack::TestPattern.new(options[:pattern]))
runner.run(tests)



