#!/usr/bin/env ruby
$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'tack'
require 'pp'
require 'optparse'

def require_ruby_debug
  require 'rubygems' unless ENV['NO_RUBYGEMS']
  require 'ruby-debug'
end

options = {}
option_parser = OptionParser.new do |opts|
  opts.banner = "Usage: tack [options] [file]"
  opts.on("-I","--include PATH", "specify $LOAD_PATH (may be used more than once)") do |path|
    options[:include] = path.split(":")
  end
  opts.on("-n", "--name PATTERN", "run only tests that match pattern") do |pattern|
    if pattern=~/^\/.*\/$/
     options[:pattern] = Regexp.new(pattern[1..-2])
    else
      options[:pattern] = pattern
    end
  end
  opts.on("-u", "--debugger", "Enable ruby-debugging.") do
    require_ruby_debug
  end
  opts.on("-o", "--profile [NUMBER]", "Display a text-based progress bar with profiling data on the NUMBER slowest examples (defaults to 10)") do |number|
    options[:profile_number] = number || 10
  end
  opts.on_tail("-h","--help", "Show this message") do
    puts opts
    exit
  end
end

args = ARGV
option_parser.parse! args
options[:paths] = ARGV

if includes = options[:include]
  $LOAD_PATH.unshift *includes
end

runner = Tack::Runner.new(:root => Dir.pwd) do |runner|
  runner.use Tack::Formatters::Profiler, :tests => options[:profile_number].to_i if options[:profile_number]
  runner.use Tack::Formatters::TotalTime
  runner.use Tack::Formatters::PrintFailures  
  runner.use Tack::Formatters::BasicSummary
  runner.use Tack::Formatters::ProgressBar
end

set = Tack::TestSet.new(Dir.pwd)
tests = set.tests_for(options[:paths], Tack::TestPattern.new(options[:pattern]))

runner.run(tests)

exit 0



